# Feature: Search & Select

## Profile

**Persona:** Prompt power user with a growing library (50-500+ prompts)

**Current pain:** As the library grows, finding the right prompt becomes difficult. Users can't quickly locate prompts by content. There's no way to mark important prompts. Editing work can be lost on browser refresh.

**What they can do after this feature:**
- Search across all prompt content instantly
- See their most-used prompts surface automatically
- Pin and favorite important prompts
- Edit prompts without fear of losing work
- Access all capabilities from both web UI and chat surfaces (MCP)

---

## Scope

### In Scope

- Full-text search across prompts
- Smart ranking (usage, recency, explicit signals)
- Pin and favorite prompts
- Durable drafts (edits persist across refresh)
- MCP tool parity with web UI

### Out of Scope

- Folder/hierarchy navigation (flat list with search for MVP)
- Semantic/vector search (keyword search first)
- Prompt versioning (separate feature)
- Real-time collaboration
- Conflict resolution for concurrent edits

---

## User Flows & Acceptance Criteria

### Flow 1: Search Prompts (New)

**Before:** User scrolls through list or uses browser find.

**After:** User types in search box, results filter instantly across slug, name, description, and content.

**Flow:**
1. User focuses search input
2. User types query
3. Results filter as they type (instant feedback)
4. Results show prompts where query matches any field
5. User selects a result to view

**Variations:**
- Empty query returns full list
- No matches shows "No prompts match your search" message
- Search combined with tag filter returns intersection
- Pinned/favorited prompts do not appear unless they match; pin/favorite only boosts rank within matched results

**Acceptance Criteria:**

| ID | Criteria |
|----|----------|
| AC-1 | User can type in search box and see results filter as they type |
| AC-2 | Search matches prompts where query appears in slug, name, description, or content |
| AC-3 | Search is case-insensitive |
| AC-4 | Empty search shows full prompt list |
| AC-5 | Search with no matches shows "No prompts match" message |
| AC-6 | Search can be combined with tag filter (ANY-of selected tags) |
| AC-7 | Search feels responsive while typing rapidly |

**Test Conditions:**

| TC | Condition | ACs |
|----|-----------|-----|
| TC-1 | Given prompts exist, when user types query matching content, then matching prompts shown | AC-1, AC-2 |
| TC-2 | Given prompt with "SQL" in name, when user searches "sql", then prompt appears in results | AC-3 |
| TC-3 | Given empty search box, when user views list, then all prompts shown | AC-4 |
| TC-4 | Given no prompts match query, when user searches, then "No prompts match" message shown | AC-5 |
| TC-5 | Given prompts with tags, when user selects multiple tags (ANY-of), then prompts matching any selected tag returned | AC-6 |
| TC-6 | Given user typing quickly, then search remains responsive | AC-7 |

---

### Flow 2: Ranked Prompt List (Changed)

**Before:** Prompts listed in creation order.

**After:** Prompts ranked by relevance: pinned first, then by combination of usage frequency and recency.

**Flow:**
1. User opens prompt list
2. Pinned prompts appear at top
3. Remaining prompts sorted by usage × recency score
4. Most-used recent prompts surface naturally

**Outcome:** User's "working set" of prompts is always visible without scrolling.

**Edge case:** User with zero prompts sees "Create your first prompt" call-to-action.

**Supporting behavior - Usage tracking:**
- Copying a prompt (web) increments usage count and updates "last used" timestamp
- Running/tracking a prompt (MCP) increments usage count and updates "last used" timestamp
- Listing or searching does NOT increment usage
- Works identically across web copy and MCP track/run (async)

**Acceptance Criteria:**

| ID | Criteria |
|----|----------|
| AC-8 | Prompt list is sorted by ranking score by default |
| AC-9 | Pinned prompts always appear at top of list |
| AC-10 | Among pinned prompts, sort by ranking score |
| AC-11 | Favorited prompts rank higher than non-favorited (with similar usage) |
| AC-12 | Frequently used prompts rank higher than rarely used |
| AC-13 | Recently used prompts rank higher than stale prompts |
| AC-14 | Prompts never used appear lower than used prompts |
| AC-15 | Ranking behavior can be tuned to improve relevance over time |
| AC-16 | Zero prompts shows "Create your first prompt" call-to-action |
| AC-17 | Copying or running a prompt increments its usage count |
| AC-18 | Copying or running a prompt updates its last-used timestamp |
| AC-19 | Listing prompts does not increment usage |
| AC-20 | Searching prompts does not increment usage |
| AC-21 | Usage tracking works identically via web UI and MCP |

**Test Conditions:**

| TC | Condition | ACs |
|----|-----------|-----|
| TC-7 | Given prompts with varying usage, when list displayed, then sorted by ranking | AC-8 |
| TC-8 | Given pinned prompt with low usage, then appears above high-usage unpinned prompt | AC-9 |
| TC-9 | Given multiple pinned prompts, then sorted by score among themselves | AC-10 |
| TC-10 | Given favorited and non-favorited with similar usage, then favorited ranks higher | AC-11 |
| TC-11 | Given high-usage and low-usage prompts, then high-usage ranks higher | AC-12 |
| TC-12 | Given recently-used and stale prompts, then recent ranks higher | AC-13 |
| TC-13 | Given never-used prompt, then appears below used prompts | AC-14 |
| TC-14 | Given user has no prompts, then "Create your first prompt" shown | AC-16 |
| TC-15 | Given prompt copied (web) or run/tracked (MCP), then usage count incremented | AC-17 |
| TC-16 | Given prompt copied (web) or run/tracked (MCP), then last-used timestamp updated | AC-18 |
| TC-17 | Given prompt list requested, then usage counts unchanged | AC-19 |
| TC-18 | Given search performed, then usage counts unchanged | AC-20 |
| TC-19 | Given MCP `track_prompt_use` called, then usage tracked same as web copy | AC-21 |

---

### Flow 3: Pin/Favorite Prompts (New)

**Before:** No way to mark important prompts.

**After:** User can pin prompts (always at top) and favorite prompts (boosted in ranking).

**Flow - Pin:**
1. User views a prompt
2. User clicks pin icon in header
3. Prompt immediately appears at top of list
4. Pin icon shows filled state
5. Clicking again unpins

**Flow - Favorite:**
1. User views a prompt
2. User clicks star icon in header
3. Prompt ranks higher in list
4. Star icon shows filled state
5. Clicking again unfavorites

**Visual indicators:**
- Pinned prompts show pin icon in sidebar list
- Favorited prompts show star icon in sidebar list

**Acceptance Criteria:**

| ID | Criteria |
|----|----------|
| AC-22 | User can pin a prompt from the prompt view |
| AC-23 | User can unpin a previously pinned prompt |
| AC-24 | User can favorite a prompt from the prompt view |
| AC-25 | User can unfavorite a previously favorited prompt |
| AC-26 | Pin/favorite changes reflect immediately in UI |
| AC-27 | Pinned prompts show pin icon in sidebar list |
| AC-28 | Favorited prompts show star icon in sidebar list |

**Test Conditions:**

| TC | Condition | ACs |
|----|-----------|-----|
| TC-20 | Given prompt view, when user clicks pin, then prompt becomes pinned | AC-22 |
| TC-21 | Given pinned prompt, when user clicks pin, then prompt becomes unpinned | AC-23 |
| TC-22 | Given prompt view, when user clicks star, then prompt becomes favorited | AC-24 |
| TC-23 | Given favorited prompt, when user clicks star, then prompt becomes unfavorited | AC-25 |
| TC-24 | Given pin/favorite clicked, then change reflects immediately in list | AC-26 |
| TC-25 | Given pinned prompt in list, then pin icon visible | AC-27 |
| TC-26 | Given favorited prompt in list, then star icon visible | AC-28 |

---

### Flow 4: Durable Drafts (Changed)

**Before:** Edits stored in browser memory. Lost on refresh. Line edits save immediately.

**After:** Edits persist as drafts across browser refresh, tabs, and sessions (up to 24 hours). Line edits accumulate as a draft until explicitly saved or discarded.

**Flow - Edit existing prompt:**
1. User clicks Edit on a prompt
2. User makes changes
3. Changes automatically save as draft
4. User can refresh browser - draft preserved
5. User returns later - sees "Unsaved changes" indicator
6. User clicks Save to commit or Discard to abandon

**Flow - Create new prompt:**
1. User clicks +New
2. User fills in fields
3. Draft automatically saved
4. User can add multiple drafts (batch)
5. User can refresh - drafts preserved
6. User saves one, some, or all drafts

**Flow - Line edit:**
1. User views a prompt (not in edit mode)
2. User clicks a line to edit inline
3. Edit saves as draft (not immediately committed)
4. User can make additional line edits - all accumulate in draft
5. Save/Discard buttons appear
6. User clicks Save to commit all changes, or Discard to abandon

**Draft indicators:**
- Header shows "Unsaved changes" when drafts exist
- Clicking indicator navigates to draft content
- Warning shown when draft approaches expiration

**Acceptance Criteria:**

| ID | Criteria |
|----|----------|
| AC-29 | Edits in edit mode are automatically saved as draft |
| AC-30 | Line edits are saved as draft (not immediately committed) |
| AC-31 | Multiple line edits accumulate in the same draft |
| AC-32 | New prompt entries are automatically saved as draft |
| AC-33 | Multiple new drafts can exist simultaneously |
| AC-34 | Drafts survive browser refresh |
| AC-35 | Drafts are accessible from other browser tabs |
| AC-36 | "Unsaved changes" indicator appears when drafts exist |
| AC-37 | Clicking the indicator navigates to draft content |
| AC-38 | User can save draft (commits to database) |
| AC-39 | User can discard draft (clears without saving) |
| AC-40 | If save fails, draft is preserved |
| AC-41 | Drafts expire after 24 hours |
| AC-42 | Warning shown when draft approaches expiration |

**Test Conditions:**

| TC | Condition | ACs |
|----|-----------|-----|
| TC-27 | Given user editing prompt, when field changed, then change saved as draft | AC-29 |
| TC-28 | Given user in view mode, when line edited, then change saved as draft | AC-30 |
| TC-29 | Given user makes multiple line edits, then all edits in same draft | AC-31 |
| TC-30 | Given user creating prompt, when fields entered, then saved as draft | AC-32 |
| TC-31 | Given user clicking +New multiple times, then multiple drafts exist | AC-33 |
| TC-32 | Given draft exists, when browser refreshed, then draft restored | AC-34 |
| TC-33 | Given draft in Tab A, when Tab B opened, then indicator visible in Tab B | AC-35 |
| TC-34 | Given draft exists, then "Unsaved changes" indicator shown | AC-36 |
| TC-35 | Given indicator clicked, then navigates to draft content | AC-37 |
| TC-36 | Given draft, when Save clicked, then changes committed to database | AC-38 |
| TC-37 | Given draft, when Discard clicked, then draft cleared | AC-39 |
| TC-38 | Given save fails, then draft preserved | AC-40 |
| TC-39 | Given draft older than 24h, then draft expired | AC-41 |
| TC-40 | Given draft near expiration, then warning shown | AC-42 |

---

### Flow 5: MCP Tool Parity (New)

**Before:** MCP has basic save/get/delete. No list, search, or update.

**After:** Full functionality available from chat surfaces.

**New capabilities via MCP:**
- List prompts (ranked)
- Search prompts (with query and tag filter)
- List tags
- Update existing prompt
- Track prompt usage (track_prompt_use)

**Outcome:** User in Claude Code or Cursor has same capabilities as web UI.

**Acceptance Criteria:**

| ID | Criteria |
|----|----------|
| AC-43 | MCP tool `list_prompts` returns prompts sorted by ranking |
| AC-44 | MCP tool `list_prompts` accepts optional limit parameter |
| AC-45 | MCP tool `search_prompts` accepts query and returns matches |
| AC-46 | MCP tool `search_prompts` accepts optional tags filter |
| AC-47 | MCP tool `list_tags` returns user's unique tags |
| AC-48 | MCP tool `update_prompt` modifies existing prompt by slug |
| AC-49 | Users receive clear error messages when MCP operations fail |
| AC-50 | MCP tool `track_prompt_use` increments usage count and updates last-used timestamp |

**Test Conditions:**

| TC | Condition | ACs |
|----|-----------|-----|
| TC-41 | Given MCP client, when `list_prompts` called, then ranked prompts returned | AC-43 |
| TC-42 | Given MCP client, when `list_prompts` called with limit, then limited results returned | AC-44 |
| TC-43 | Given MCP client, when `search_prompts` called with query, then matches returned | AC-45 |
| TC-44 | Given MCP client, when `search_prompts` called with tags, then filtered results returned | AC-46 |
| TC-45 | Given MCP client, when `list_tags` called, then user's tags returned | AC-47 |
| TC-46 | Given MCP client, when `update_prompt` called, then prompt updated | AC-48 |
| TC-47 | Given MCP operation fails, then user receives clear error message | AC-49 |
| TC-48 | Given MCP client, when `track_prompt_use` called, then usage incremented and timestamp updated | AC-50 |

---

## Non-Functional Requirements

### Durable Drafts

Partially edited prompts must not be lost due to browser refresh, tab closure, or brief disconnection. This requires persistence beyond browser memory.

**Requirements:**
- Draft data persists for at least 24 hours
- Drafts accessible across browser tabs (same user)
- Draft service must be highly available

### Search Performance

Search must feel instant for typical library sizes.

**Requirements:**
- Search results appear within 200ms for libraries up to 500 prompts
- Typeahead feels responsive (no perceived lag)
- Search re-ranking is capped at 200 matched prompts to ensure responsiveness

### Cross-Surface Consistency

Users moving between web UI and MCP surfaces should have consistent experience.

**Requirements:**
- Same prompts visible in both surfaces
- Same ranking applied in both surfaces
- Usage tracking works in both surfaces

---

## Architectural Overview

### New Infrastructure: Redis

To meet the durable drafts NFR, we introduce Redis (Upstash) as a persistence layer for ephemeral user data.

**Redis responsibilities:**
- Drafts (in-progress prompts, dirty edits)
- User session state (UI preferences)

**Not in Redis:**
- Prompt data (stays in Convex - source of truth)
- Search indexes (handled by Convex)
- Ranking computation (handled at query time)

### Search Implementation

Convex provides built-in full-text search indexes. A `searchText` field concatenates searchable content, and a search index enables fast queries.

### Data Flow Summary

```
Prompt CRUD, Search, Ranking  →  Convex (source of truth)
Drafts, User State            →  Redis (ephemeral persistence)
```
