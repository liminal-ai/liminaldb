# Prompt 3.R: Verify Durable Drafts Backend (Story 3)

**Target Model:** GPT-5.2

**Story:** Durable Drafts Backend (Story 3)

**Working Directory:** `/Users/leemoore/promptdb`

## Reference Documents

- Feature Spec: `docs/epics/02-search-select/01.search.select.feature.md`
- Tech Design: `docs/epics/02-search-select/02.search.select.tech-design.md`
- Story: `docs/epics/02-search-select/stories/story-3-drafts-backend/story.md`
- Skeleton Prompt: `docs/epics/02-search-select/stories/story-3-drafts-backend/prompt-3.1-skeleton-red.md`
- Green Prompt: `docs/epics/02-search-select/stories/story-3-drafts-backend/prompt-3.2-green.md`

## Objective

Verify Redis integration and draft API endpoints work as specified, with 24-hour TTL and draft persistence.

## Output Requirements (GPT-5.2)

- Provide a 1-paragraph summary.
- Then provide a checklist with Pass/Fail for each section below.
- If anything fails or is blocked, add a short **Fixes** section with concrete next steps.

---

## AC Coverage

| AC | Description | Verification Method |
|----|-------------|---------------------|
| AC-34 | Drafts survive browser refresh | TC-32 (automated) |
| AC-35 | Drafts visible across tabs (backend support) | Manual (summary endpoint) |
| AC-38 | Save commits draft data | TC-36 (automated) |
| AC-39 | Discard clears draft | TC-37 (automated) |
| AC-41 | Drafts expire after 24 hours | TC-39 (automated) |

---

## Verification Commands

```bash
bun run typecheck
bun run test --project service \
  tests/service/drafts/drafts.test.ts \
  tests/service/prompts/updatePrompt.test.ts
```

## Automated Tests

All of these should PASS:

| Test File | TCs | Expected |
|-----------|-----|----------|
| `tests/service/drafts/drafts.test.ts` | TC-32, TC-36, TC-37, TC-39 | 4 tests |
| **Story 3 Verification Total** | | **4+ tests** |
| **Running Total** | | **baseline + Story 3 tests** |

## Manual Verification

Requires Redis running and authenticated session or token.

1) **Create draft and verify persistence**
```bash
curl -sS -X PUT http://localhost:5001/api/drafts/edit:test-prompt \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type":"edit","promptSlug":"test-prompt","data":{"slug":"test-prompt","name":"Test","description":"D","content":"C","tags":["t"]}}'
```

2) **List drafts**
```bash
curl -sS http://localhost:5001/api/drafts \
  -H "Authorization: Bearer $TOKEN"
```

3) **Summary (cross-tab support)**
```bash
curl -sS http://localhost:5001/api/drafts/summary \
  -H "Authorization: Bearer $TOKEN"
```

4) **Verify TTL is set (~86400 seconds)**
Use the actual Redis key pattern from the tech design:
```bash
# Optional: discover keys for the current user
redis-cli SCAN 0 MATCH "liminal:draft:*" COUNT 100

# Then check TTL on the specific draft key
redis-cli TTL "liminal:draft:{userId}:{draftId}"
```

5) **Delete draft**
```bash
curl -sS -X DELETE http://localhost:5001/api/drafts/edit:test-prompt \
  -H "Authorization: Bearer $TOKEN"
```

---

## Checklist

### Automated
- [ ] All Story 3 verification tests pass
- [ ] All tests pass (baseline + Story 3)
- [ ] `bun run typecheck` passes

### Implementation Details
- [ ] `src/lib/redis.ts` uses Bun `RedisClient` and `REDIS_URL`
- [ ] `src/lib/redis.ts` exports `setRedisClient()` for test injection
- [ ] `set` uses `EX` TTL for 24-hour expiration
- [ ] Draft keys follow tech design: `liminal:draft:{userId}:{draftId}`
- [ ] Draft index keys follow tech design: `liminal:drafts:index:{userId}`
- [ ] Draft IDs are UUIDs (generated by client)
- [ ] `GET /api/drafts/summary` returns count + latest + expiry warning flags
- [ ] Drafts are stored and retrieved from Redis (no in-memory fallback)
- [ ] Draft routes use `authMiddleware` + `request.user?.id` (not `getAuthenticatedUser`)
- [ ] Tests use `createTestJwt()` + mocked `validateJwt` pattern

### Manual
- [ ] Draft creation succeeds
- [ ] Draft list returns created draft
- [ ] Summary reflects draft count
- [ ] TTL is set and expiring
- [ ] Draft delete removes data

---

## Story 3 Complete When

All checklist items pass and no blockers remain.
